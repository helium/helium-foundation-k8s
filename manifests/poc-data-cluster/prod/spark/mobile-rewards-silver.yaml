apiVersion: v1
kind: ConfigMap
metadata:
  name: mobile-rewards-silver-query
  namespace: spark
data:
  query.sql: |
    SELECT
      date,
      start_period,
      end_period,
      b58encodeChecked(gateway_reward.hotspot_key) as gateway,
      gateway_reward.dc_transfer_reward as dc_transfer_amount_mobile
    FROM mobile_reward_share
---
apiVersion: "sparkoperator.k8s.io/v1beta2"
kind: SparkApplication
metadata:
  name: mobile-rewards-silver
  namespace: spark
spec:
  type: Scala
  mode: cluster
  image: "public.ecr.aws/k0m1p4t7/spark:v3.4.0-aws"
  imagePullPolicy: Always
  mainClass: Main
  mainApplicationFile: "s3a://foundation-data-lake-requester-pays/jars/spark-streaming-sql-assembly-1.0.jar"
  sparkVersion: "3.4.0"
  restartPolicy:
    type: OnFailure
    onFailureRetries: 3
    onFailureRetryInterval: 10
    onSubmissionFailureRetries: 3
    onSubmissionFailureRetryInterval: 10
  sparkConf:
    spark.databricks.delta.autoCompact.enabled: "true"
  hadoopConf:
    fs.s3a.aws.credentials.provider: com.amazonaws.auth.WebIdentityTokenCredentialsProvider
  volumes:
    - name: "tmp"
      hostPath:
        path: "/tmp"
        type: Directory
    - name: config-vol
      configMap:
        name: mobile-rewards-silver-query
        items:
          - key: query.sql
            path: query.sql
  driver:
    serviceAccount: spark-data-lake-access
    cores: 1
    coreLimit: "1200m"
    memory: "512m"
    nodeSelector:
      node.kubernetes.io/instance-type: m5.large
    envVars:
      TABLE_MOBILE_REWARD_SHARE: s3a://foundation-data-lake-requester-pays/bronze/mobile_reward_share
      PARTITION_BY: "date"
      CHECKPOINT: s3a://foundation-data-lake-requester-pays/checkpoints/mobile-reward-share
      OUTPUT: s3a://foundation-data-lake-requester-pays/silver/mobile-reward-share
      QUERY_PATH: /app/query.sql
    labels:
      version: 3.4.0
    volumeMounts:
      - name: "test-volume"
        mountPath: "/tmp"
      - name: config-vol
        mountPath: /app
  executor:
    serviceAccount: spark-data-lake-access
    cores: 1
    coreLimit: "1200m"
    instances: 2
    memory: "10G"
    tolerations: # Schedule executor pods on spot instance group
      - key: dedicated
        operator: Equal
        value: spark
        effect: NoSchedule
    nodeSelector:
      nodegroup-type: spot
    labels:
      version: 3.4.0
    volumeMounts:
      - name: "tmp"
        mountPath: "/tmp"